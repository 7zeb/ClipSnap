name: Release

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: write 

jobs:
  build:
    runs-on: windows-latest
    
    strategy:
      matrix:
        runtime: [win-x64, win-arm64]
        include:
          - runtime: win-x64
            arch: AMD64
          - runtime: win-arm64
            arch: ARM64

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Generate version number
      id: version
      shell: bash
      run: |
        COMMIT_COUNT=$(git rev-list --count HEAD)
        DATE_VERSION=$(date +'%Y.%m.%d')
        VERSION="${DATE_VERSION}.${COMMIT_COUNT}"
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"

    - name: Restore dependencies
      run: dotnet restore src/ClipSnap/ClipSnap.sln

    # Build Framework-Dependent
    - name: Build Framework-Dependent (${{ matrix.arch }})
      run: |
        dotnet publish src/ClipSnap/ClipSnap/ClipSnap.csproj `
          --configuration Release `
          --output ./publish/${{ matrix.runtime }}/framework-dependent `
          --runtime ${{ matrix.runtime }} `
          --self-contained false `
          -p:PublishSingleFile=true `
          -p:Version=${{ steps.version.outputs.VERSION }}

    # Build Self-Contained
    - name: Build Self-Contained (${{ matrix.arch }})
      run: |
        dotnet publish src/ClipSnap/ClipSnap/ClipSnap.csproj `
          --configuration Release `
          --output ./publish/${{ matrix.runtime }}/self-contained `
          --runtime ${{ matrix.runtime }} `
          --self-contained true `
          -p:PublishSingleFile=true `
          -p:EnableCompressionInSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:Version=${{ steps.version.outputs.VERSION }}

    # Create ZIP archives
    - name: Create ZIP archives
      shell: pwsh
      run: |
        Compress-Archive -Path ./publish/${{ matrix.runtime }}/framework-dependent/* `
          -DestinationPath ./ClipSnap-${{ steps.version.outputs.VERSION }}-${{ matrix.runtime }}.zip
        
        Compress-Archive -Path ./publish/${{ matrix.runtime }}/self-contained/* `
          -DestinationPath ./ClipSnap-${{ steps.version.outputs.VERSION }}-${{ matrix.runtime }}-standalone.zip

    # Upload artifacts
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ClipSnap-${{ matrix.runtime }}-${{ steps.version.outputs.VERSION }}
        path: |
          ./ClipSnap-${{ steps.version.outputs.VERSION }}-${{ matrix.runtime }}.zip
          ./ClipSnap-${{ steps.version.outputs.VERSION }}-${{ matrix.runtime }}-standalone.zip
        retention-days: 1

    # Save version
    - name: Save version
      shell: bash
      run: echo "${{ steps.version.outputs.VERSION }}" > version.txt

    - name: Upload version
      uses: actions/upload-artifact@v4
      with:
        name: version-${{ matrix.runtime }}
        path: version.txt
        retention-days: 1

  create-release:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: Get version
      id: version
      run: |
        VERSION=$(cat ./artifacts/version-win-x64/version.txt)
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"

    - name: Display downloaded files
      run: |
        echo "Downloaded artifacts:"
        find ./artifacts -type f

    - name: Prepare release files
      run: |
        mkdir -p ./release-files
        find ./artifacts -name "*.zip" -exec cp {} ./release-files/ \;
        ls -lh ./release-files/

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: ClipSnap v${{ steps.version.outputs.VERSION }}
        tag_name: v${{ steps.version.outputs.VERSION }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: ./release-files/*.zip
        body: |
          ## ClipSnap v${{ steps.version.outputs.VERSION }}
          
          Auto-generated multi-architecture release.
          
          ### Downloads
          
          #### AMD64 (x64) - For Intel/AMD processors
          - **ClipSnap-${{ steps.version.outputs.VERSION }}-win-x64.zip** - Requires .NET 8 Runtime (~5 MB)
          - **ClipSnap-${{ steps.version.outputs.VERSION }}-win-x64-standalone.zip** - Standalone, no runtime needed (~70 MB)
          
          #### ARM64 - For ARM processors (Surface Pro X, etc.)
          - **ClipSnap-${{ steps.version.outputs.VERSION }}-win-arm64.zip** - Requires .NET 8 Runtime (~5 MB)
          - **ClipSnap-${{ steps.version.outputs.VERSION }}-win-arm64-standalone.zip** - Standalone, no runtime needed (~70 MB)
          
          ### Installation
          1. Download the appropriate ZIP file for your processor
          2. Extract and run `ClipSnap.exe`
          3. The app will minimize to your system tray
          
          Use **Win+Shift+S** or **Print Screen** to capture screenshots!
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
